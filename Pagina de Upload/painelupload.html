<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Gerenciador de M√≠dias ‚Äî Pro</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f1f5f9;
            --surface: #ffffff;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; }
        
        .header {
            background: var(--surface); padding: 1rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .logo { background: var(--primary); color: white; padding: 8px 12px; border-radius: 8px; font-weight: bold; }

        .container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; padding: 2rem 5%; max-width: 1400px; margin: 0 auto; }
        @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }

        .panel { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow); }

        .list { display: flex; flex-direction: column; gap: 12px; }
        
        .card {
            display: grid; grid-template-columns: auto 1fr auto; align-items: center;
            gap: 1.5rem; padding: 1rem; background: var(--surface);
            border: 2px solid var(--border); border-radius: var(--radius);
            cursor: move; transition: all 0.2s;
        }
        .card:hover { border-color: var(--primary); background: #f8fafc; }
        .card.dragging { opacity: 0.4; border: 2px dashed var(--primary); transform: scale(0.98); }

        .thumb {
            width: 120px; height: 68px; border-radius: 8px; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border: 1px solid var(--border);
        }
        .thumb img, .thumb video { width: 100%; height: 100%; object-fit: cover; }

        .meta-info { display: flex; flex-direction: column; gap: 4px; }
        .meta-info .title { font-weight: 600; font-size: 0.95rem; }
        .meta-info .badge { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

        .btn {
            padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            font-size: 0.85rem; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-ghost:hover { background: #f1f5f9; color: var(--text-main); }
        .btn-refresh { border: 1px solid var(--primary); color: var(--primary); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        .modal { background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); }
        
        input { width: 100%; padding: 0.8rem; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; outline: none; }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s;
            z-index: 2000;
        }
        .toast.show { opacity: 1; bottom: 40px; }
    </style>
</head>

<body>
    <header class="header">
        <a href="../index.html" class="brand">
            <div class="logo">MD</div>
            <div>
                <h1 style="font-size: 1.1rem; margin:0">Painel Administrativo</h1>
                <small id="empresaLabel">Unidade...</small>
            </div>
        </a>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <button class="btn btn-ghost btn-refresh" onclick="forcarRefreshRemoto()">üîÑ Refresh TV</button>
            <a href="../index.html" class="btn btn-ghost">üè† In√≠cio</a>
            <span id="userLabel" style="font-size: 0.8rem; opacity: 0.7;">...</span>
        </div>
    </header>

    <main class="container">
        <section>
            <div class="panel">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h2 style="margin:0; font-size: 1.25rem;">Minha Playlist</h2>
                    <button class="btn btn-primary" onclick="abrirModal()">Ôºã Adicionar M√≠dia</button>
                </div>
                <div id="list" class="list"></div>
                <div id="noMedia" style="text-align:center; padding: 50px; display:none; color: var(--text-muted);">
                    Sua lista est√° vazia.
                </div>
            </div>
        </section>

        <aside style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div class="panel">
                <h3 style="font-size: 1rem; margin-top:0">Upload Catbox</h3>
                <button class="btn btn-ghost" style="width: 100%; justify-content: center;" onclick="document.getElementById('fileInput').click()">
                    üìÅ Selecionar Arquivo
                </button>
                <div id="uploadStatus" style="font-size: 0.75rem; text-align: center; margin-top: 10px;"></div>
            </div>
        </aside>
    </main>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">Configurar M√≠dia</h3>
            <label style="font-size: 0.8rem; font-weight:600">T√≠tulo</label>
            <input id="nomeMidia" placeholder="Ex: Promo√ß√£o do Dia">
            
            <label style="font-size: 0.8rem; font-weight:600">URL da M√≠dia</label>
            <input id="linkMidia" placeholder="https://...">

            <label style="font-size: 0.8rem; font-weight:600">Ordem na Playlist</label>
            <input id="ordemMidia" type="number" placeholder="Ex: 1">

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-ghost" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarMidia()">Salvar</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" hidden>
    <div id="toast" class="toast"></div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDE1V9V4w0YbqJBgkeI7F4fN3sW_YokVBQ",
            authDomain: "midiaindoor-d2109.firebaseapp.com",
            databaseURL: "https://midiaindoor-d2109-default-rtdb.firebaseio.com",
            projectId: "midiaindoor-d2109",
            storageBucket: "midiaindoor-d2109.appspot.com",
            messagingSenderId: "549200922225",
            appId: "1:549200922225:web:731664468eb51fbdf2bdd0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let midiaEditandoId = null;
        let dragSrcEl = null;

        auth.onAuthStateChanged(user => {
            if (!user) { window.location.href = 'login.html'; return; }
            const empresaId = localStorage.getItem('empresaId') || 'empresa1';
            document.getElementById('userLabel').textContent = user.email;
            document.getElementById('empresaLabel').textContent = 'Unidade: ' + empresaId;
            listarMidias();
        });

        // --- UTILIT√ÅRIOS ---
        function getTipoByUrl(url) {
            const u = url.toLowerCase();
            if (u.match(/\.(jpeg|jpg|gif|png|webp|svg)$/)) return "IMAGEM";
            if (u.match(/\.(mp4|webm|mov|ogg)$/)) return "VIDEO";
            return "M√çDIA";
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // --- SINCRONIZA√á√ÉO EM TEMPO REAL ---
        async function forcarRefreshRemoto() {
            const empresaId = localStorage.getItem('empresaId') || 'empresa1';
            try {
                await db.collection('empresas').doc(empresaId).set({
                    lastUpdate: Date.now()
                }, { merge: true });
                showToast("üîÑ Comando enviado para a TV!");
            } catch (error) {
                showToast("Erro ao sincronizar.");
            }
        }

        // --- GEST√ÉO DE M√çDIAS ---
        async function listarMidias() {
            const empresaId = localStorage.getItem('empresaId') || 'empresa1';
            const snap = await db.collection('empresas').doc(empresaId).collection('midias').orderBy('ordem').get();
            const list = document.getElementById('list');
            list.innerHTML = '';

            if (snap.empty) { document.getElementById('noMedia').style.display = 'block'; return; }
            document.getElementById('noMedia').style.display = 'none';

            snap.forEach(doc => {
                const data = doc.data();
                const tipo = getTipoByUrl(data.url);
                const card = document.createElement('div');
                card.className = 'card';
                card.draggable = true;
                card.dataset.id = doc.id;
                card.dataset.ordem = data.ordem;

                let thumbContent = '';
                if (tipo === 'IMAGEM') thumbContent = `<img src="${data.url}">`;
                else if (tipo === 'VIDEO') thumbContent = `<video src="${data.url}#t=0.1" muted></video>`;
                else {
                    const domain = new URL(data.url).hostname;
                    thumbContent = `<img src="https://www.google.com/s2/favicons?sz=128&domain=${domain}" style="width:32px;height:32px">`;
                }

                card.innerHTML = `
                    <div class="thumb">${thumbContent}</div>
                    <div class="meta-info">
                        <span class="badge">${tipo} ‚Ä¢ POSI√á√ÉO ${data.ordem}</span>
                        <span class="title">${data.nome}</span>
                    </div>
                    <div style="display:flex; gap:8px">
                        <button class="btn btn-ghost" onclick="abrirModal('${doc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn" style="color:var(--danger)" onclick="excluirMidia('${doc.id}')">‚úï</button>
                    </div>
                `;

                // Drag & Drop
                card.addEventListener('dragstart', e => { dragSrcEl = card; card.classList.add('dragging'); });
                card.addEventListener('dragover', e => e.preventDefault());
                card.addEventListener('drop', async e => {
                    e.preventDefault();
                    if (dragSrcEl !== card) {
                        const batch = db.batch();
                        const docRef1 = db.collection('empresas').doc(empresaId).collection('midias').doc(dragSrcEl.dataset.id);
                        const docRef2 = db.collection('empresas').doc(empresaId).collection('midias').doc(card.dataset.id);
                        
                        batch.update(docRef1, { ordem: parseInt(card.dataset.ordem) });
                        batch.update(docRef2, { ordem: parseInt(dragSrcEl.dataset.ordem) });
                        
                        await batch.commit();
                        forcarRefreshRemoto(); // Atualiza a TV ap√≥s o drag
                        listarMidias();
                    }
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));

                list.appendChild(card);
            });
        }

        async function salvarMidia() {
            const empresaId = localStorage.getItem('empresaId') || 'empresa1';
            const url = document.getElementById('linkMidia').value;
            const payload = {
                nome: document.getElementById('nomeMidia').value,
                url: url,
                tipo: getTipoByUrl(url),
                ordem: parseInt(document.getElementById('ordemMidia').value) || 0
            };

            if (midiaEditandoId) {
                await db.collection('empresas').doc(empresaId).collection('midias').doc(midiaEditandoId).update(payload);
            } else {
                await db.collection('empresas').doc(empresaId).collection('midias').add(payload);
            }
            
            fecharModal();
            forcarRefreshRemoto(); // Sincroniza TV
            listarMidias();
            showToast("Playlist atualizada!");
        }

        async function excluirMidia(id) {
            if(confirm("Remover m√≠dia?")) {
                const eid = localStorage.getItem('empresaId') || 'empresa1';
                await db.collection('empresas').doc(eid).collection('midias').doc(id).delete();
                forcarRefreshRemoto(); // Sincroniza TV
                listarMidias();
            }
        }

        // --- MODAL ---
        function abrirModal(id = null, data = null) {
            midiaEditandoId = id;
            document.getElementById('modalTitle').textContent = id ? "Editar M√≠dia" : "Nova M√≠dia";
            document.getElementById('nomeMidia').value = data ? data.nome : '';
            document.getElementById('linkMidia').value = data ? data.url : '';
            document.getElementById('ordemMidia').value = data ? data.ordem : '';
            document.getElementById('modalOverlay').classList.add('show');
        }

        function fecharModal() { document.getElementById('modalOverlay').classList.remove('show'); }

        // --- UPLOAD CATBOX ---
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('uploadStatus');
            status.textContent = "‚è≥ Enviando...";
            const fd = new FormData();
            fd.append('reqtype', 'fileupload');
            fd.append('fileToUpload', file);
            try {
                const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: fd });
                const url = await res.text();
                status.textContent = "‚úÖ Sucesso!";
                abrirModal();
                document.getElementById('linkMidia').value = url;
                document.getElementById('nomeMidia').value = file.name;
            } catch { status.textContent = "‚ùå Erro no upload"; }
        };
    </script>
</body>
</html>
