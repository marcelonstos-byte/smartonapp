<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart M√≠dia ‚Ä¢ Relat√≥rio Detalhado</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --primary: #0f172a;
            --brand: #0b63a5;
            --brand-dark: #074a7d;
            --success: #22c55e;
            --danger: #ef4444;
            --muted: #64748b;
            --border: #e2e8f0;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            background-image: radial-gradient(at 0% 0%, rgba(11, 99, 165, 0.05) 0px, transparent 50%);
            margin: 0; 
            padding: 40px 20px;
            color: var(--primary);
        }

        .container { max-width: 1100px; margin: 0 auto; }

        /* --- Barra de Filtros Estilizada --- */
        #filtros { 
            background: var(--card); 
            padding: 24px; 
            border-radius: var(--radius-lg); 
            display: flex; 
            gap: 16px; 
            align-items: flex-end; 
            margin-bottom: 30px; 
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .fcol { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
        
        label { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        
        input, select { 
            padding: 10px 14px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-family: inherit;
            font-size: 14px;
            outline: none;
            background-color: #fcfcfd;
        }

        input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(11, 99, 165, 0.1); }

        /* --- Bot√µes --- */
        .btn { 
            padding: 11px 20px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-update { background: var(--brand); color: white; }
        .btn-update:hover { background: var(--brand-dark); transform: translateY(-1px); }

        .btn-pdf { background: #10b981; color: white; }
        .btn-pdf:hover { background: #059669; transform: translateY(-1px); }

        .btn-clear { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .btn-clear:hover { background: var(--danger); color: white; }

        .btn-back { 
            background: white; 
            color: var(--primary); 
            border: 1px solid var(--border);
            text-decoration: none;
            padding: 11px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-back:hover { border-color: var(--brand); color: var(--brand); transform: translateX(-4px); }

        .btn-logout { background: transparent; color: var(--muted); border: 1px solid var(--border); margin-left: auto; }
        .btn-logout:hover { background: #f1f5f9; color: var(--primary); }

        /* --- Container do Relat√≥rio (PDF) --- */
        #reportContainer { 
            background: var(--card); 
            padding: 50px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            border: 1px solid var(--border);
        }

        .report-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 30px; 
            margin-bottom: 40px; 
        }

        .logo-container img { height: 50px; filter: grayscale(1) contrast(1.2); opacity: 0.9; }
        
        .info-box { 
            background: #f1f5f9; 
            padding: 16px 20px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 14px;
        }
        .info-box span { font-weight: 800; color: var(--brand); }

        /* --- Estat√≠sticas --- */
        .top-cards { display: flex; gap: 20px; margin-bottom: 40px; }
        .card { 
            flex: 1; 
            padding: 24px; 
            border-radius: 16px; 
            text-align: left; 
            background: #f8fafc; 
            border: 1px solid var(--border); 
        }
        .card .value { font-size: 36px; font-weight: 800; color: var(--primary); display: block; letter-spacing: -1px; }
        .card .label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-top: 4px; }

        /* --- Tabela --- */
        table { width: 100%; border-collapse: collapse; }
        thead th { 
            background: #f1f5f9; 
            color: var(--muted); 
            padding: 16px; 
            text-align: left; 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            border-radius: 8px 8px 0 0;
        }
        tbody td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tbody tr:hover { background: #fafbfc; }
        
        .thumb { 
            width: 44px; 
            height: 44px; 
            border-radius: 10px; 
            background: #e2e8f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
        }

        #loadingOverlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:white; display:flex; justify-content:center; 
            align-items:center; z-index:9999; font-weight:bold; color: var(--brand); 
        }

        @media (max-width: 768px) {
            #filtros { flex-direction: column; align-items: stretch; }
            .btn-logout { margin-left: 0; }
            #reportContainer { padding: 20px; }
            .top-cards { flex-direction: column; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay">Carregando painel de auditoria...</div>

<div class="container">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <a href="../index.html" class="btn-back">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Voltar
        </a>
        <button class="btn btn-logout" id="logoutBtn">Sair da Conta</button>
    </div>

    <div id="filtros">
        <div class="fcol"><label>Conte√∫do</label><select id="mediaSelect"><option value="todas">Todas as M√≠dias</option></select></div>
        <div class="fcol"><label>Data In√≠cio</label><input type="date" id="dataInicio"></div>
        <div class="fcol"><label>Data Fim</label><input type="date" id="dataFim"></div>
        <button class="btn btn-update" onclick="filtrarEExibir()">Atualizar Relat√≥rio</button>
        <button class="btn btn-pdf" id="btnGerarPDF">üìÑ Gerar PDF</button>
        <button class="btn btn-clear" onclick="limparRelatorioBanco()">üóëÔ∏è Resetar Logs</button>
    </div>

    <div id="reportContainer">
        <div class="report-header">
            <div class="logo-container">
                <img src="https://i.ibb.co/996n69W/Smart-On-Logo.png" alt="Smart M√≠dia">
            </div>
            <div style="text-align: right">
                <div style="font-weight: 800; color: var(--primary); font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Relat√≥rio de Exibi√ß√µes</div>
                <div id="dataGeracao" style="font-size: 12px; color: var(--muted); margin-top: 4px;"></div>
            </div>
        </div>

        <div class="info-box">
            <div>Empresa: <span id="labelEmpresa">---</span> | Terminais Ativos: <span id="labelPainel">...</span></div>
            <div id="userEmail" style="font-size: 11px; opacity: 0.7;"></div>
        </div>

        <div class="top-cards">
            <div class="card">
                <span class="value" id="totalExibicoes">0</span>
                <span class="label">Total de Impactos</span>
            </div>
            <div class="card">
                <span class="value" id="totalMidias">0</span>
                <span class="label">Materiais Distintos</span>
            </div>
        </div>

        <table id="relatorioTabela">
            <thead>
                <tr>
                    <th>M√≠dia / Conte√∫do</th>
                    <th style="text-align: center;">Vezes Exibida</th>
                    <th style="text-align: center;">√öltima Reprodu√ß√£o</th>
                </tr>
            </thead>
            <tbody id="relatorioCorpo"></tbody>
        </table>
        
        <div id="semResultados" style="display:none; padding: 100px 20px; text-align: center; color: var(--muted); font-weight: 500;">
            Nenhum dado encontrado para o per√≠odo ou m√≠dia selecionada.
        </div>
    </div>
</div>

<script>
    // Configura√ß√£o permanece a mesma
    const firebaseConfig = {
        apiKey: "AIzaSyDE1V9V4w0YbqJBgkeI7F4fN3sW_YokVBQ",
        authDomain: "midiaindoor-d2109.firebaseapp.com",
        databaseURL: "https://midiaindoor-d2109-default-rtdb.firebaseio.com",
        projectId: "midiaindoor-d2109",
        storageBucket: "midiaindoor-d2109.firebasestorage.app",
        messagingSenderId: "549200922225",
        appId: "1:549200922225:web:731664468eb51fbdf2bdd0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    let dadosOriginais = [];
    let empresaID = "empresa1"; 

    auth.onAuthStateChanged(async user => {
        if (!user) {
            window.location.href = `../login.html`;
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('userEmail').innerText = user.email;
            inicializarRelatorio();
        }
    });

    async function inicializarRelatorio() {
        const params = new URLSearchParams(window.location.search);
        empresaID = params.get('empresa') || localStorage.getItem('empresaId') || "empresa1";
        document.getElementById('labelEmpresa').innerText = empresaID.toUpperCase();

        database.ref(`exibicoes/${empresaID}`).on('value', snapshot => {
            const paineis = snapshot.val();
            if (!paineis) {
                limparInterface();
                return;
            }

            let lista = [];
            const nomesDosPaineis = Object.keys(paineis);
            document.getElementById('labelPainel').innerText = nomesDosPaineis.length;

            nomesDosPaineis.forEach(pId => {
                const midiasLog = paineis[pId];
                if(typeof midiasLog !== 'object') return;
                
                Object.keys(midiasLog).forEach(midiaKey => {
                    const log = midiasLog[midiaKey];
                    const nomeExibicao = log.conteudo || log.nome || "Desconhecido";
                    
                    lista.push({
                        nome: nomeExibicao,
                        timestamp: log.timestamp ? new Date(log.timestamp) : null
                    });
                });
            });

            dadosOriginais = lista.filter(i => i.timestamp);
            popularSelect();
            filtrarEExibir();
        });
    }

    function limparInterface() {
        document.getElementById('labelPainel').innerText = "0";
        document.getElementById('relatorioCorpo').innerHTML = '';
        document.getElementById('totalExibicoes').innerText = "0";
        document.getElementById('totalMidias').innerText = "0";
        document.getElementById('relatorioTabela').style.display = 'none';
        document.getElementById('semResultados').style.display = 'block';
    }

    function limparRelatorioBanco() {
        const confirmacao = confirm("ATEN√á√ÉO: Isso apagar√° permanentemente todos os logs de exibi√ß√£o desta empresa. Deseja continuar?");
        if (confirmacao) {
            database.ref(`exibicoes/${empresaID}`).remove()
                .then(() => alert("Relat√≥rio limpo com sucesso!"))
                .catch(err => alert("Erro ao limpar banco: " + err.message));
        }
    }

    function popularSelect() {
        const select = document.getElementById('mediaSelect');
        const nomesUnicos = [...new Set(dadosOriginais.map(d => d.nome))];
        select.innerHTML = '<option value="todas">Todas as M√≠dias</option>';
        nomesUnicos.forEach(nome => {
            const opt = document.createElement('option');
            opt.value = nome;
            opt.textContent = nome;
            select.appendChild(opt);
        });
    }

    function filtrarEExibir() {
        const mSel = document.getElementById('mediaSelect').value;
        const dIniInput = document.getElementById('dataInicio').value;
        const dFimInput = document.getElementById('dataFim').value;

        const dIni = dIniInput ? new Date(dIniInput + 'T00:00:00') : null;
        const dFim = dFimInput ? new Date(dFimInput + 'T23:59:59') : null;

        const filtrados = dadosOriginais.filter(d => {
            if (mSel !== 'todas' && d.nome !== mSel) return false;
            if (dIni && d.timestamp < dIni) return false;
            if (dFim && d.timestamp > dFim) return false;
            return true;
        });

        const corpo = document.getElementById('relatorioCorpo');
        corpo.innerHTML = '';
        const agrupado = {};

        filtrados.forEach(d => {
            if (!agrupado[d.nome]) agrupado[d.nome] = { total: 0, ultima: d.timestamp };
            agrupado[d.nome].total++;
            if (d.timestamp > agrupado[d.nome].ultima) agrupado[d.nome].ultima = d.timestamp;
        });

        const nomesAgrupados = Object.keys(agrupado);
        nomesAgrupados.forEach(nome => {
            const info = agrupado[nome];
            corpo.innerHTML += `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="thumb">üéûÔ∏è</div>
                            <div><strong style="color:var(--primary);">${nome}</strong></div>
                        </div>
                    </td>
                    <td style="text-align:center; font-weight:800; color:var(--brand); font-size:16px;">${info.total.toLocaleString()}</td>
                    <td style="text-align:center; color:var(--muted); font-weight:500;">${info.ultima.toLocaleString('pt-BR')}</td>
                </tr>`;
        });

        document.getElementById('totalExibicoes').innerText = filtrados.length.toLocaleString();
        document.getElementById('totalMidias').innerText = nomesAgrupados.length;
        document.getElementById('dataGeracao').innerText = "Documento gerado em: " + new Date().toLocaleString();
        document.getElementById('relatorioTabela').style.display = filtrados.length ? 'table' : 'none';
        document.getElementById('semResultados').style.display = filtrados.length ? 'none' : 'block';
    }

    document.getElementById('btnGerarPDF').addEventListener('click', async () => {
        const btn = document.getElementById('btnGerarPDF');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Processando...";
        btn.disabled = true;
        
        try {
            const canvas = await html2canvas(document.getElementById('reportContainer'), { scale: 2, useCORS: true });
            const img = canvas.toDataURL('image/jpeg', 1.0);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(img, 'JPEG', 10, 10, pdfWidth, pdfHeight);
            pdf.save(`Relatorio_${empresaID}.pdf`);
        } catch (err) { console.error(err); }
        
        btn.innerText = originalText;
        btn.disabled = false;
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm("Deseja sair da conta?")) auth.signOut().then(() => { window.location.href = '../login.html'; });
    });
</script>
</body>
</html>
